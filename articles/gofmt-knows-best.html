<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="icon" href="/images/favicon.png" type="image/png"/>
<link href="/styles/application.css" media="all" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/scripts/prettify.js"></script>
<script type="text/javascript" src="/scripts/lang-lisp.js"></script>
<title>Gofmt knows best</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="author" content="Thomas Guest" />
<meta name="description" content="A Word Aligned article posted 2016-03-07, tagged Go." />
<meta name="keywords" content="Go" />
<link rel="alternate" type="application/rss+xml" title="Feed" href="http://feeds.wordaligned.org/wordaligned" />
</head>

<body onload="prettyPrint()">
<div id="container">
  <div id="header">
<h1><span><a accesskey="h" href="/">Word Aligned</a></span></h1>
<h2>tales from the code face</h2>
<a class="button" href="http://feeds.wordaligned.org/wordaligned" title="Subscribe to Word Aligned"><img style="float: right;" src="/images/feed.png" alt="Feed Logo" height="28" width="28"/></a>
</div>

  <div id="page">
    <div id="content">
      <div class="atomentry" id="gofmt-knows-best">
<h2 class="title"><a href="/articles/gofmt-knows-best">Gofmt knows best</a></h2>
<p class="meta"><abbr class="published" title="2016-03-07">2016-03-07</abbr> &bull; <a href="/tag/go" rel="tag">Go</a> &bull; <a href="/articles/gofmt-knows-best#disqus_thread">Comments</a></p>
<h2 id="everyones-favourite">Everyone&#8217;s favourite</h2>
<blockquote>
<p>Gofmt&#8217;s style is no one&#8217;s favorite, yet gofmt is everyone&#8217;s favorite.
&#8212; <a href="https://go-proverbs.github.io">Rob Pike</a></p>
</blockquote>
<p>Code formatting tools are nothing new but Go notches them up a level. Your Go installation comes with an automated formatter, <a href="https://golang.org/cmd/gofmt/">gofmt</a>, and this tool has been used to layout the entire code base. As a result, Go code looks uniform and familiar. The recommendation is to gofmt your own code, ideally on save and certainly before submitting for review.</p>
<div class="typocode">

<pre class="prettyprint">(add-hook &#x27;before-save-hook &#x27;gofmt-before-save)

</pre>

</div>

<p><a href="http://clang.llvm.org/docs/ClangFormatStyleOptions.html">Formatting tools for other languages</a> require configuration. You must instruct the tool about your preferences for spaces and braces. Gofmt is inflexible and this is a strength.</p>
<p>The language designers did Go a favour by supplying and promoting gofmt early on, before alternative style guides had been developed and adopted. There can be no more arguments about tabs vs spaces, for example. Code reviews must focus on content rather than layout.</p>
<p>There are also more subtle benefits. Certain kinds of manual layout are fragile: the insertion of space to vertically align assignment statements, for example. A code formatter gets it right every time.</p>
<h2 id="go-knows-best">Go knows best</h2>
<p>As writers &#8212; and programmers are, fundamentally, <a href="http://wordaligned.org/articles/lessons-from-the-oulipo">writers</a> &#8212; maybe we don&#8217;t want our work to look uniform or familiar. Maybe we prefer more control over what we produce. Maybe sometimes, we&#8217;d like to surprise or provoke.</p>
<p>Does the regularity gofmt imposes render our code bland, even boring?</p>
<p>I&#8217;ve heard this point extended to be a criticism of Go in general: that the language restricts what you can do because the language designers know best, and that it&#8217;s for your own good.</p>
<p>Well, if I&#8217;ve ever submitted extravagently formatted code for review, it&#8217;s been slapped back. Substantial programs are developed by teams who adopt idiom and share style rules for good reason. It&#8217;s how we work together. Imagine how much easier it would be if the third party code in your code base was also written to your preferred style. Go gives you that, so long as you prefer its native style.</p>
<p>Gofmt does not completely over-ride a programmer&#8217;s choices. Two programs which are semantically identical but laid out differently will probably still be laid out differently after a pass through gofmt.</p>
<h2 id="when-formatters-fail">When formatters fail</h2>
<p>Formatting sometimes fails. Some examples follow.</p>
<h3 id="decluttered-java">Decluttered Java</h3>
<p>Here&#8217;s some creatively formatted Java. Of course it&#8217;s a joke, and a funny one, but a language like Python, and indeed go, gets the last laugh. It <strong>is</strong> possible to get rid of braces and semicolons and your code <strong>will</strong> look better for it.</p>
<div><blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">I finally figured out how to get those pesky semicolons and curly braces out of my Java code <a href="http://t.co/Ns96HdCuKO">pic.twitter.com/Ns96HdCuKO</a></p>&mdash; Uncle Bob&#39;s Nephew (@thedirtycoder) <a href="https://twitter.com/thedirtycoder/status/569339014085517312">February 22, 2015</a></blockquote><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>

<h3 id="tetrominoes">Tetrominoes</h3>
<p>Here&#8217;s an equally witty but perfectly sensible use of non-standard layout.</p>
<blockquote class="twitter-tweet" data-cards="hidden" data-lang="en"><p lang="en" dir="ltr">I always love it when code is formatted in the shape of the problem it&#39;s solving.<a href="https://t.co/XC7J2cSENj">pic.twitter.com/XC7J2cSENj</a></p>&mdash; Mathias Verraes (@mathiasverraes) <a href="https://twitter.com/mathiasverraes/status/669490082022367232">November 25, 2015</a></blockquote>

<p>Mathias is referring to some tetrominoes &#8212; tetris shapes &#8212; coded in <a href="http://elm-lang.org">elm</a> by <a href="https://github.com/jcollard/elmtris/blob/master/src/Tetromino.elm">Joseph Collard</a>.</p>
<div class="typocode">

<pre class="prettyprint">-- A Tetromino is a list of Locations. By definition, a valid tetromino
-- should contain exactly 4 different locations
type Tetromino = [Location]

line : Tetromino
line = [(0,0), (1,0), (2,0), (3,0)]

square : Tetromino
square = [(0,0), (1,0),
          (0,1), (1,1)]

spiece : Tetromino
spiece = [       (1,0), (2,0),
          (0,1), (1,1)]

jpiece : Tetromino
jpiece = [       (1,0),
                 (1,1),
          (0,2), (1,2)]

</pre>

</div>

<p>For brevity, I&#8217;ve left out the Z and L pieces. I&#8217;ve also omitted comments from the original, which I would suggest are redundant since the code has been painstakingly formatted to indicate the shape of the pieces.</p>
<p>The same tetrominoes in hand-formatted Go read:</p>
<div class="typocode">

<pre class="prettyprint">package tetris

type Tetronimo [4][2]int

var (
    Line   = Tetronimo   {{0, 0}, {1, 0}, {2, 0}, {3, 0}}

    Square = Tetronimo   {{0, 0}, {1, 0}, 
                          {0, 1}, {1, 1}}

    Spiece = Tetronimo   {        {1, 0}, {2, 0}, 
                          {0, 1}, {1, 1}}

    Jpiece = Tetronimo   {        {1, 0}, 
                                  {1, 1}, 
                          {0, 2}, {1, 2}}
)

</pre>

</div>

<p>Gofmt spoils them:</p>
<div class="typocode">

<pre class="prettyprint">package tetris

type Tetronimo [4][2]int

var (
    Line = Tetronimo{{0, 0}, {1, 0}, {2, 0}, {3, 0}}

    Square = Tetronimo{{0, 0}, {1, 0},
        {0, 1}, {1, 1}}

    Spiece = Tetronimo{{1, 0}, {2, 0},
        {0, 1}, {1, 1}}

    Jpiece = Tetronimo{{1, 0},
        {1, 1},
        {0, 2}, {1, 2}}
)

</pre>

</div>

<h3 id="obfuscation">Obfuscation</h3>
<p>Here&#8217;s a tiny rectangular program <a href="http://accu.org/index.php/journals/256">submitted by Thaddaeus Frogley</a> to the International Obfuscated C Code Contest in 2001. It&#8217;s <strong>meant</strong> to be hard to read and the compact layout helps, by hindering.</p>
<div class="typocode">

<pre class="prettyprint">/*(c) 2001 Thad */
#include&lt;string.h&gt;
#include &lt;stdio.h&gt;
#define abc stdout
int main(int a,ch\
ar*b){char*c="??="
"??(??/??/??)??&#x27;{"
"??!??&gt;??-";while(
!((a=fgetc(stdin))
==EOF))fputc((b=s\
trchr(c,a))?fputc(
fputc(077,abc),abc
),"=(/)&#x27;&lt;!&gt;""-"??(
b-c??):a, abc);??&gt;

</pre>

</div>

<p>In the author&#8217;s own words:</p>
<blockquote>
<p>I wanted to create a piece of code that could be considered to be &#8220;art&#8221; on multiple levels.</p>
</blockquote>
<p>He&#8217;s succeeded. It&#8217;s impossible to translate this program into Go so I cannot gofmt it. If, instead, I try <a href="http://clang.llvm.org/docs/ClangFormatStyleOptions.html">clang-format</a>, the resulting code <strong>no longer compiles</strong>! Obfuscation has bamboozled the formatter.</p>
<div class="typocode">

<pre class="prettyprint">/*(c) 2001 Thad */
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#define abc stdout
int main(int a, ch\
ar *b) {
  char *c = "??="
            "??(??/??/??)??&#x27;{"
            "??!??&gt;??-";
  while (!((a = fgetc(stdin)) == EOF))fputc((b=s\
trchr(c,a))?fputc(
fputc(077,abc),abc
),"=(/)&#x27;&lt;!&gt;""-"??(
b-c??):a, abc);
? ? &gt;

</pre>

</div>

<h3 id="depth-first-search">Depth First Search</h3>
<p>Finally, here&#8217;s a recursive depth first search from the <a href="https://github.com/boostorg/graph/blob/develop/include/boost/graph/depth_first_search.hpp#L181">boost graph library</a></p>
<div class="typocode">

<pre class="prettyprint">template &lt;class IncidenceGraph, class DFSVisitor, class ColorMap,
          class TerminatorFunc&gt;
void depth_first_visit_impl
  (const IncidenceGraph&amp; g,
   typename graph_traits&lt;IncidenceGraph&gt;::vertex_descriptor u,
   DFSVisitor&amp; vis,  // pass-by-reference here, important!
   ColorMap color, TerminatorFunc func)
{
  typedef typename graph_traits&lt;IncidenceGraph&gt;::vertex_descriptor Vertex;
  typedef typename property_traits&lt;ColorMap&gt;::value_type ColorValue;
  typedef color_traits&lt;ColorValue&gt; Color;
  typename graph_traits&lt;IncidenceGraph&gt;::out_edge_iterator ei, ei_end;

  put(color, u, Color::gray());          vis.discover_vertex(u, g);

  if (!func(u, g))
    for (boost::tie(ei, ei_end) = out_edges(u, g); ei != ei_end; ++ei) {
      Vertex v = target(*ei, g);           vis.examine_edge(*ei, g);
      ColorValue v_color = get(color, v);
      if (v_color == Color::white()) {     vis.tree_edge(*ei, g);
      depth_first_visit_impl(g, v, vis, color, func);
      } else if (v_color == Color::gray()) vis.back_edge(*ei, g);
      else                                 vis.forward_or_cross_edge(*ei, g);
      call_finish_edge(vis, *ei, g);
    }
  put(color, u, Color::black());         vis.finish_vertex(u, g);
}

</pre>

</div>

<p>Clients of the function supply a visitor, <code>vis</code>, which is called back as vertices and edges are discovered and classified. These callbacks are carefully placed on the right hand side, visually distinguishing the core traversal from associated events. Note too the alignment, with edge events indented to the right of vertex events. Again, a code formatter tramples over this elegantly shaped code:</p>
<div class="typocode">

<pre class="prettyprint">template &lt;class IncidenceGraph, class DFSVisitor, class ColorMap,
          class TerminatorFunc&gt;
void depth_first_visit_impl(
    const IncidenceGraph &amp;g,
    typename graph_traits&lt;IncidenceGraph&gt;::vertex_descriptor u,
    DFSVisitor &amp;vis, // pass-by-reference here, important!
    ColorMap color, TerminatorFunc func) {
  typedef typename graph_traits&lt;IncidenceGraph&gt;::vertex_descriptor Vertex;
  typedef typename property_traits&lt;ColorMap&gt;::value_type ColorValue;
  typedef color_traits&lt;ColorValue&gt; Color;
  typename graph_traits&lt;IncidenceGraph&gt;::out_edge_iterator ei, ei_end;

  put(color, u, Color::gray());
  vis.discover_vertex(u, g);

  if (!func(u, g))
    for (boost::tie(ei, ei_end) = out_edges(u, g); ei != ei_end; ++ei) {
      Vertex v = target(*ei, g);
      vis.examine_edge(*ei, g);
      ColorValue v_color = get(color, v);
      if (v_color == Color::white()) {
        vis.tree_edge(*ei, g);
        depth_first_visit_impl(g, v, vis, color, func);
      } else if (v_color == Color::gray())
        vis.back_edge(*ei, g);
      else
        vis.forward_or_cross_edge(*ei, g);
      call_finish_edge(vis, *ei, g);
    }
  put(color, u, Color::black());
  vis.finish_vertex(u, g);
}

</pre>

</div>

<h2 id="conclusion">Conclusion</h2>
<p>Creative code formatting does have a place. Generally, though, gofmt gets it right: an automated tool can and should take care of formatting our code base, and the benefits are amplified if the tool is inflexible. With formatting solved we can focus our creative energy where it counts. </p>
</div>

<div class="comments"><hr/><div id="disqus_thread"></div><script type="text/javascript" src="http://disqus.com/forums/wordaligned/embed.js"></script></div>
      
<div id="comments"><script type="text/javascript">
//<![CDATA[
(function() {
    var links = document.getElementsByTagName('a');
    var query = '?';
    for(var i = 0; i < links.length; i++) {
        if(links[i].href.indexOf('#disqus_thread') >= 0) {
            query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&amp;';
        }
    }
    document.write('<script type="text/javascript" src="http://disqus.com/forums/wordaligned/get_num_replies.js' + query + '"></' + 'script>');
})();
//]]>
</script></div>

    </div>
    <div id="sidebar">
      
<div class="sidebar-node">
<h3>Tagged</h3>
<ul id="categories"><li><a href="/tag/go" rel="tag">Go</a></li></ul>

</div>

<div class="sidebar-node">
<h3>Chain</h3>
<ul>
<li><a accesskey="n" href="/articles/sausages-slices" title="Next article">&laquo; Sausages, sausages, sausages - slice, slice, slice</a></li>
<li><a accesskey="p" href="/articles/sledgehammers-vs-nut-crackers" title="Previous article">&raquo; Sledgehammers vs Nut Crackers</a></li>
</ul>


</div>

<div class="sidebar-node">
<h3>Feeds</h3>

<ul>
<li><a href="http://feeds.wordaligned.org/wordaligned"><img src="/images/buttons/feed-icon-14x14.png" alt="feed icon"/> Articles</a></li>
<li><a href="http://feeds.wordaligned.org/wordaligned/comments"><img src="/images/buttons/feed-icon-14x14.png" alt="feed icon"/> Comments</a></li>
</ul>


</div>

    </div>
  </div>
  <div id="footer">
<hr />
<p><a href="http://tag.wordaligned.org">Thomas Guest</a></p>
</div>

</div>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3373724-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();
</script>
</body>

</html>
