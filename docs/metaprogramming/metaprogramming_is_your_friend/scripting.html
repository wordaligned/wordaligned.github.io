<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Scripting</title>
<link rel="stylesheet" href="../../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.67.0">
<link rel="start" href="../index.html" title="Metaprogramming is Your Friend">
<link rel="up" href="../index.html" title="Metaprogramming is Your Friend">
<link rel="prev" href="compilation.html" title="Compilation">
<link rel="next" href="cpp.html" title=" Metaprogramming in C++">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><td valign="top"></td></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="compilation.html"><img src="../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../images/home.png" alt="Home"></a><a accesskey="n" href="cpp.html"><img src="../../images/next.png" alt="Next"></a>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="metaprogramming_is_your_friend.scripting"></a>Scripting</h2></div></div></div>
<a name="scripting.a_generated_text_codec"></a><h1>
<a name="id4749220"></a>A Generated Text Codec</h1>
<p>
</p>
<p>
The program which follows is a short but non-trivial <a href="http://www.python.org" target="_top">Python</a> script. It makes
use of a couple of text codecs from the <a href="http://www.python.org" target="_top">Python</a> standard library to generate a
C++ function. This C++ function converts a single character from ISO 8859-9
encoding into UTF-8 encoded <a href="http://www.unicode.org" target="_top">Unicode</a>.</p>
<pre class="programlisting">
<code class="literal">
<span class="keyword">def</span><span class="identifier"> warnGenerated</span><span class="special">():</span><span class="string">
   '''Return a standard "generated code" warning.'''</span><span class="keyword">
   import</span><span class="identifier"> sys</span><span class="special">,</span><span class="identifier"> time</span><span class="keyword">
   return</span><span class="special"> (</span><span class="string">
       '// GENERATED CODE. DO NOT EDIT!\n'</span><span class="string">
       '// generated by %s, %s'</span><span class="special"> %</span><span class="special">
       (</span><span class="string">' '</span><span class="special">.</span><span class="identifier">join</span><span class="special">(</span><span class="identifier">sys</span><span class="special">.</span><span class="identifier">argv</span><span class="special">),</span><span class="identifier">
        time</span><span class="special">.</span><span class="identifier">asctime</span><span class="special">(</span><span class="identifier">time</span><span class="special">.</span><span class="identifier">localtime</span><span class="special">()))</span><span class="special">
       )</span><span class="keyword">

def</span><span class="identifier"> functionHeader</span><span class="special">(</span><span class="identifier">codec</span><span class="special">):</span><span class="string">
   '''Return the decode function header.'''</span><span class="keyword">
   return</span><span class="string"> '''\
/**
 * @brief Convert from %(codec)s into UTF-8 encoded Unicode
 * @param %(codec)s An %(codec)s encoded character
 * @param it Reference to an output iterator
 *
 * @note If the input character is invalid, the Unicode 
 * replacement character U+FFFD will be returned.
 */
template &lt;typename output_iterator&gt;
void
%(codec)s_to_utf8(
   unsigned char %(codec)s,
   output_iterator &amp; it)'''</span><span class="special"> %</span><span class="special"> {</span><span class="string"> 'codec'</span><span class="special"> :</span><span class="identifier"> codec</span><span class="special"> }</span><span class="keyword">

def</span><span class="identifier"> convertCh</span><span class="special">(</span><span class="identifier">ch</span><span class="special">,</span><span class="identifier"> codec</span><span class="special">):</span><span class="string">
   '''Return the 'case' statement converting
   the input character using the supplied codec'''</span><span class="keyword">

   from</span><span class="identifier"> unicodedata</span><span class="keyword"> import</span><span class="identifier"> name</span><span class="identifier">

   ucs</span><span class="special"> =</span><span class="identifier"> chr</span><span class="special">(</span><span class="identifier">ch</span><span class="special">).</span><span class="identifier">decode</span><span class="special">(</span><span class="identifier">codec</span><span class="special">,</span><span class="string"> 'replace'</span><span class="special">)</span><span class="identifier">
   utf</span><span class="special"> =</span><span class="identifier"> ucs</span><span class="special">.</span><span class="identifier">encode</span><span class="special">(</span><span class="string">'utf-8'</span><span class="special">)</span><span class="identifier">
   ucname</span><span class="special"> =</span><span class="identifier"> name</span><span class="special">(</span><span class="identifier">ucs</span><span class="special">,</span><span class="string"> 'Control code'</span><span class="special">)</span><span class="identifier">
   action</span><span class="special"> =</span><span class="string"> '; '</span><span class="special">.</span><span class="identifier">join</span><span class="special">([</span><span class="string">'*it++ = 0x%02x'</span><span class="special"> %</span><span class="identifier"> ord</span><span class="special">(</span><span class="identifier">c</span><span class="special">)</span><span class="keyword">
                       for</span><span class="identifier"> c</span><span class="keyword"> in</span><span class="identifier"> utf</span><span class="special">])</span><span class="keyword">

   return</span><span class="string"> '''case 0x%02x: // %s
   %s;
   break;'''</span><span class="special"> %</span><span class="special"> (</span><span class="identifier">ch</span><span class="special">,</span><span class="identifier"> ucname</span><span class="special">,</span><span class="identifier"> action</span><span class="special">)</span><span class="keyword">

def</span><span class="identifier"> codeBlock</span><span class="special">(</span><span class="identifier">prefix</span><span class="special">,</span><span class="identifier"> body</span><span class="special">,</span><span class="identifier"> indent</span><span class="special"> =</span><span class="string"> ' '</span><span class="special"> *</span><span class="number"> 4</span><span class="special">):</span><span class="string">
   '''Return an indented code block.

   This code block will be formatted:
   prefix
   {
       body
   }'''</span><span class="keyword">
   import</span><span class="identifier"> re</span><span class="identifier">
   indent_re</span><span class="special"> =</span><span class="identifier"> re</span><span class="special">.</span><span class="identifier">compile</span><span class="special">(</span><span class="string">'^'</span><span class="special">,</span><span class="identifier"> re</span><span class="special">.</span><span class="identifier">MULTILINE</span><span class="special">)</span><span class="keyword">
   return</span><span class="string"> '''%s
{
%s
}'''</span><span class="special"> %</span><span class="special"> (</span><span class="identifier">prefix</span><span class="special">,</span><span class="identifier"> indent_re</span><span class="special">.</span><span class="identifier">sub</span><span class="special">(</span><span class="identifier">indent</span><span class="special">,</span><span class="identifier"> body</span><span class="special">))</span><span class="identifier">

codec</span><span class="special"> =</span><span class="string"> 'iso8859_9'</span><span class="keyword">

print</span><span class="identifier"> warnGenerated</span><span class="special">()</span><span class="keyword">

print</span><span class="identifier"> codeBlock</span><span class="special">(</span><span class="identifier">
   functionHeader</span><span class="special">(</span><span class="identifier">codec</span><span class="special">),</span><span class="identifier">
   codeBlock</span><span class="special">(</span><span class="string">
       'switch(%s)'</span><span class="special"> %</span><span class="identifier"> codec</span><span class="special">,</span><span class="comment">
       # iso8859-* encodings are 8-bit
</span><span class="string">       '\n'</span><span class="special">.</span><span class="identifier">join</span><span class="special">([</span><span class="identifier">convertCh</span><span class="special">(</span><span class="identifier">ch</span><span class="special">,</span><span class="identifier"> codec</span><span class="special">)</span><span class="keyword">
                  for</span><span class="identifier"> ch</span><span class="keyword"> in</span><span class="identifier"> range</span><span class="special">(</span><span class="number">0x100</span><span class="special">)]),</span><span class="identifier">
       indent</span><span class="special"> =</span><span class="string"> ''</span><span class="comment"> # don't indent case: labels
</span><span class="special">       )</span><span class="special">
   )</span></code>
</pre>
<p>
By now, it should go without saying that this script is a metaprogram. Before
discussing why I think it's a good use of metaprogramming, some
notes:</p>
<div class="itemizedlist"><ul type="disc">
<li>
The function <code class="code"><span class="identifier">warnGenerated</span><span class="special">()</span></code> is used to place a standard warning in
      front of the generated C++ function. If users of this C++ function edit
      it by hand, their changes will be overwritten next time the script is
      run: hence the warning.
</li>
<li>
The generated code identifies the command which created it (this
      information appears as part of the standard warning). This is to help
      users regenerate the code, if required.
</li>
<li>
It is very important that the <a href="http://www.python.org" target="_top">Python</a> script is both maintained and easy to
      locate. Ideally, the build system includes a rule to generate the C++
      from the script, though this behaviour may be hard to integrate into
      some IDEs: it may prove more pragmatic to run the script by hand and
      keep the dependent C++ code checked directly into the repository.
</li>
<li>
Notice how <a href="http://www.python.org" target="_top">Python</a>'s triple quoted strings allow us to create neatly
      formatted C++ code from neatly formatted <a href="http://www.python.org" target="_top">Python</a> code without needing
      lots of escaped characters.
</li>
<li>
It is perhaps ironic that, according to the <a href="http://www.python.org" target="_top">Python</a> documentation, some
      of <a href="http://www.python.org" target="_top">Python</a>'s built-in text codecs are implemented in C (presumably for reasons
      of speed). I haven't worked out if this applies to the ones this script
      uses.
</li>
</ul></div>
<p>
I like this script since it makes use of the standard <a href="http://www.python.org" target="_top">Python</a> library to create
code we can use in a C++ program. The hard work goes on in the calls to
<code class="code"><span class="identifier">encode</span><span class="special">()</span></code> and <code class="code"><span class="identifier">decode</span><span class="special">()</span></code> and we don't even have to look at the
implementations of these functions, let alone maintain them. Their speed does
not affect the speed of our C++ function and I am willing to trust their
correctness, meaning I don't have to locate or purchase the ISO 8859 standards.</p>
<p>
The second big win is that all the boilerplate code is generated without
effort. If, at some point in the future, we need a fuller range of ISO 8859
text converters, then we tweak the script so the final section reads, for
example:</p>
<pre class="programlisting">
<code class="literal">
<span class="identifier">codecs</span><span class="special"> =</span><span class="special"> [</span><span class="string">'iso8859_%d'</span><span class="special"> %</span><span class="identifier"> n</span><span class="keyword"> for</span><span class="identifier"> n</span><span class="keyword"> in</span><span class="identifier"> range</span><span class="special">(</span><span class="number">1</span><span class="special">,</span><span class="number"> 10</span><span class="special">)]</span><span class="keyword">

print</span><span class="identifier"> warnGenerated</span><span class="special">()</span><span class="keyword">

for</span><span class="identifier"> codec</span><span class="keyword"> in</span><span class="identifier"> codecs</span><span class="special">:</span><span class="keyword">
    print</span><span class="identifier"> codeBlock</span><span class="special">(</span><span class="identifier">
        functionHeader</span><span class="special">(</span><span class="identifier">codec</span><span class="special">)</span><span class="special">
            ....</span><span class="special">
        )</span></code>
</pre>
<p>
and let it run. And should we decide on a different strategy for handling
invalid input data, again, the metaprogram is our friend.</p>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><small>Copyright &copy; 2005 Thomas Guest</small></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="compilation.html"><img src="../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../images/home.png" alt="Home"></a><a accesskey="n" href="cpp.html"><img src="../../images/next.png" alt="Next"></a>
</div>
</body>
</html>
