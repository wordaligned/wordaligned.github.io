<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Metaproblems</title>
<link rel="stylesheet" href="../../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.67.0">
<link rel="start" href="../index.html" title="Metaprogramming is Your Friend">
<link rel="up" href="../index.html" title="Metaprogramming is Your Friend">
<link rel="prev" href="domain_specific_extensions.html" title="Domain Specific Extensions">
<link rel="next" href="concluding_thoughts.html" title="Concluding Thoughts">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><td valign="top"></td></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="domain_specific_extensions.html"><img src="../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../images/home.png" alt="Home"></a><a accesskey="n" href="concluding_thoughts.html"><img src="../../images/next.png" alt="Next"></a>
</div>
<div class="section" lang="en">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="metaprogramming_is_your_friend.metaproblems"></a>Metaproblems</h2></div></div></div>
<p>
Most of this article puts a positive spin on metaprogramming. I'm happy
enough to leave you with this impression, but I should also mention some
problems.</p>
<a name="metaproblems.trouble_shooting"></a><h1>
<a name="id4752098"></a>Trouble Shooting</h1>
<p>
The first problem is to do with trouble-shooting. You have problems with your
program but the problem is actually in the metaprogram which generated your
program. You are one step removed from fixing it.</p>
<p>
I deliberately used the term <span class="emphasis"><em>trouble-shooting</em></span> rather than debugging. When
you think about it, debug builds and debuggers are there to help you solve
these problems by hooking you back from machine code to source code. It gives
the illusion of reversing the effect of the compiler. If you can provide
similar hooks in your metaprograms, then similarly the fix will be easier to
find.</p>
<a name="metaproblems.quote_escape_problems"></a><h1>
<a name="id4752132"></a>Quote Escape Problems</h1>
<p>
The second problem I refer to as the <span class="emphasis"><em>quote-escape</em></span> problem. It bit me
recently when I converted a regular C++ program into one which was partially
generated by another C++ program. For details, I refer you to 
<a href="../../dvbcodec/index.html" target="_top">the original article</a>. For the purposes of this 
article, look at what happened when I needed to generate C++ code which 
produces formatted output.</p>
<p>
Here's the code I wanted to generate:</p>
<p>
</p>
<pre class="programlisting">
<code class="literal">
<span class="identifier">context</span><span class="special">.</span><span class="identifier">decodeOut</span><span class="special">()</span><span class="special">
    &lt;&lt;</span><span class="identifier"> context</span><span class="special">.</span><span class="identifier">indent</span><span class="special">()</span><span class="special">
    &lt;&lt;</span><span class="identifier"> field_name</span><span class="special"> &lt;&lt;</span><span class="string"> " "</span><span class="special">
    &lt;&lt;</span><span class="identifier"> bitwidth</span><span class="special">
    &lt;&lt;</span><span class="string"> " = 0x"</span><span class="special"> &lt;&lt;</span><span class="identifier"> value</span><span class="special"> &lt;&lt;</span><span class="string"> "\n"</span><span class="special">;</span>
</code>
</pre>
<p>
Here's the code I developed to do the generating:</p>
<pre class="programlisting">
<code class="literal">
<span class="identifier">cpp_file</span><span class="special">
    &lt;&lt;</span><span class="identifier"> indent</span><span class="special">()</span><span class="special">
    &lt;&lt;</span><span class="string"> "context.decodeOut() &lt;&lt; context.indent() &lt;&lt; "</span><span class="special">
    &lt;&lt;</span><span class="identifier"> quote</span><span class="special">(</span><span class="identifier">field_name</span><span class="special">
            +</span><span class="string"> " "</span><span class="special">
            +</span><span class="identifier"> bitwidth</span><span class="special"> 
            +</span><span class="string"> " = 0x"</span><span class="special">)</span><span class="special">
    &lt;&lt;</span><span class="string"> " &lt;&lt; context.readFieldValue("</span><span class="special">
    &lt;&lt;</span><span class="identifier"> quote</span><span class="special">(</span><span class="identifier">field_name</span><span class="special">)</span><span class="special"> +</span><span class="string"> ", "</span><span class="special">
    &lt;&lt;</span><span class="identifier"> value</span><span class="special"> 
    &lt;&lt;</span><span class="string"> ") &lt;&lt; \"\\n\";\n"</span><span class="special">;</span>
</code>
</pre>
<p>
It looks even worse without the helper function, <code class="code"><span class="identifier">quote</span></code>, which returns a
double-quoted version of the input string.</p>
<p>
I was able to defuse this problem with some refactoring but the
self-referential nature of metaprogramming will always make it susceptible to
these issues.</p>
<p>
This is also part of the reason why <a href="http://www.python.org" target="_top">Python</a> is so popular as a code-generator:
as has been shown by some of the preceding examples, its sophisticated string
support allows us to bypass most quote-escape problems.</p>
<a name="metaproblems.build_time_complexity"></a><h1>
<a name="id4752473"></a>Build Time Complexity</h1>
<p>
I have already mentioned the problem of integrating code-generators into your
build system. Some IDEs don't integrate them very well, and even if they do,
we have introduced complexity into this part of the system. In general we
prefer to trade complexity at build time for safety at run-time but we should
always check that the gains outweigh the costs.</p>
<a name="metaproblems.too_much_code"></a><h1>
<a name="id4752497"></a>Too Much Code</h1>
<p>
We're nearing the end of our investigation, and I hope the <span class="emphasis"><em>Why Metaprogram?</em></span>
question I posed <a href="../index.html#introduction.why_metaprogram_">at the beginning</a> has been addressed. 
The <a href="refs.html#refs.wikipedia">Wikipedia</a> answers this question rather more directly:</p>
<div class="blockquote"><blockquote class="blockquote"><p>[Metaprogramming] ... allows programmers to produce a larger amount of
    code and get more done in the same amount of time as they would take to
    write all the code manually.</p></blockquote></div>
<p>
It's possible to interpret this wrongly. As we all know, we want 
<a href="http://jonjagger.blogspot.com/" target="_top">less code, not more</a> 
(more software can be good, though). The important point is that the
metaprogram is what we develop and maintain and the metaprogram is small: we
shouldn't have to worry about the size of the generated code.</p>
<p>
Unfortunately we do have to worry about the generated code, not least because
it has to fit in our system. If we turn a critical eye on the 
<a href="scripting.html#scripting.a_generated_text_codec">ISO 8859 conversion functions</a>
we discussed earlier we can see that the generated code
size could be halved: values in the range  <code class="code"><span class="special">(</span><span class="number">0</span><span class="special">,</span><span class="number"> 0x7f</span><span class="special">)</span></code> translate unchanged into
UTF-8, and therefore do not require 128 separate case statements. Of course, the
metaprogram could easily be modified to take advantage of this intelligence,
but the point still holds: generated code can be bloated.</p>
<p>
See <a href="refs.html#refs.brown">Brown</a> for a more thorough discussion of this issue.</p>
<a name="metaproblems.too_clever"></a><h1>
<a name="id4752616"></a>Too Clever</h1>
<p>
Good programmers use metaprograms because they are lazy. I don't mean lazy in
the sense of <span class="emphasis"><em>Can't be bothered to put the right header in a source file</em></span>, I
mean lazy in the sense of 
<span class="emphasis"><em>Why should I do something a machine could do for me?</em></span></p>
<p>
Being lazy in this way requires a certain amount of cleverness and <span class="emphasis"><em>clever</em></span>
can be a pejorative every bit as much as <span class="emphasis"><em>lazy</em></span> can. A metaprogram lives at a
higher conceptual level than a regular program. It has to be clever.</p>
<p>
Experienced C++ programmers are used to selecting the right language features
for a particular job. Where possible, simple solutions are preferred: not
every class needs to derive from an interface, not every function needs
template-type parameters. Similarly, experienced metaprogrammers do not write
metaprograms when they can, they do it when they choose to.</p>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><small>Copyright &copy; 2005 Thomas Guest</small></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="domain_specific_extensions.html"><img src="../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../../images/up.png" alt="Up"></a><a accesskey="h" href="../../index.html"><img src="../../images/home.png" alt="Home"></a><a accesskey="n" href="concluding_thoughts.html"><img src="../../images/next.png" alt="Next"></a>
</div>
</body>
</html>
